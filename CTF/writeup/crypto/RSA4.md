---
sort: 4
---

# RSA4

## 题面

```python
import gmpy2
from Crypto.Util.number import getPrime, long_to_bytes
from sympy import nextprime
from random import randint

p = getPrime(1024)
q = getPrime(1024)
e = 54722
n = p * q  # n是2048位的
gift = lcm(p - 1 , q - 1)

flag = b'NPUCTF{******************}'
m = int.from_bytes(flag , 'big')
c = powmod(m , e , n)
print('n: ' , n)
print('gift: ' , gift)
print('c: ' , c)

/*
#n:  17083941230213489700426636484487738282426471494607098847295335339638177583685457921198569105417734668692072727759139358207667248703952436680183153327606147421932365889983347282046439156176685765143620637107347870401946946501620531665573668068349080410807996582297505889946205052879002028936125315312256470583622913646319779125559691270916064588684997382451412747432722966919513413709987353038375477178385125453567111965259721484997156799355617642131569095810304077131053588483057244340742751804935494087687363416921314041547093118565767609667033859583125275322077617576783247853718516166743858265291135353895239981121
#gift:  2135492653776686212553329560560967285303308936825887355911916917454772197960682240149821138177216833586509090969892419775958406087994054585022894165950768427741545736247918410255804894522085720642952579638418483800243368312702566458196708508543635051350999572787188236243275631609875253617015664414032058822919469443284453403064076232765024248435543326597418851751586308514540124571309152787559712950209357825576896132278045112177910266019741013995106579484868768251084453338417115483515132869594712162052362083414163954681306259137057581036657441897428432575924018950961141822554251369262248368899977337886190114104
#c:  3738960639194737957667684143565005503596276451617922474669745529299929395507971435311181578387223323429323286927370576955078618335757508161263585164126047545413028829873269342924092339298957635079736446851837414357757312525158356579607212496060244403765822636515347192211817658170822313646743520831977673861869637519843133863288550058359429455052676323196728280408508614527953057214779165450356577820378810467527006377296194102671360302059901897977339728292345132827184227155061326328585640019916328847372295754472832318258636054663091475801235050657401857262960415898483713074139212596685365780269667500271108538319
*/
```

## 思路

题目给了我们`p-1`和`q-1`的最小公倍数, 而最小公倍数有如下性质

$$
lcm(a,b) = \frac{ab}{gcd(a,b)}
$$

显然$ab$即为$(p-1)(q-1)=φ(n)$, 因此只要我们能设法获取$gcd(p-1,q-1)$的范围, 我们就可以获取到$φ(n)$的取值范围, 继而获取到私钥`d`的所有可能, 再通过私钥`d`逐个解密密文得到 flag.

那么$gcd(p-1,q-1)$的范围为多少呢? 我们来观察$gift$, 其位长为:2045
![](vx_images/3136918131163.png)

而$p-1$与$q-1$均为 1024 位, 说明$(p-1)(q-1)$为 2048 位, 那么可知$gcd(p-1,q-1)$的位长为 3 位, 其取值范围便是$[2^2, 2^3)$, 通过枚举所有的$gcd(p-1,q-1)$可以间接得到私钥, 这么范围并不是非常大, 所有可以很轻易地求解:

```python
import gmpy2
import RSATools

n = 17083941230213489700426636484487738282426471494607098847295335339638177583685457921198569105417734668692072727759139358207667248703952436680183153327606147421932365889983347282046439156176685765143620637107347870401946946501620531665573668068349080410807996582297505889946205052879002028936125315312256470583622913646319779125559691270916064588684997382451412747432722966919513413709987353038375477178385125453567111965259721484997156799355617642131569095810304077131053588483057244340742751804935494087687363416921314041547093118565767609667033859583125275322077617576783247853718516166743858265291135353895239981121
c = 3738960639194737957667684143565005503596276451617922474669745529299929395507971435311181578387223323429323286927370576955078618335757508161263585164126047545413028829873269342924092339298957635079736446851837414357757312525158356579607212496060244403765822636515347192211817658170822313646743520831977673861869637519843133863288550058359429455052676323196728280408508614527953057214779165450356577820378810467527006377296194102671360302059901897977339728292345132827184227155061326328585640019916328847372295754472832318258636054663091475801235050657401857262960415898483713074139212596685365780269667500271108538319
e = 54722
gift = 2135492653776686212553329560560967285303308936825887355911916917454772197960682240149821138177216833586509090969892419775958406087994054585022894165950768427741545736247918410255804894522085720642952579638418483800243368312702566458196708508543635051350999572787188236243275631609875253617015664414032058822919469443284453403064076232765024248435543326597418851751586308514540124571309152787559712950209357825576896132278045112177910266019741013995106579484868768251084453338417115483515132869594712162052362083414163954681306259137057581036657441897428432575924018950961141822554251369262248368899977337886190114104

gcd_range = [i for i in range(4,8)]
for i in gcd_range:
    fn = i * gift
    d = RSATools.getInvert(e//2, fn)
    try:
        m = gmpy2.isqrt(RSATools.Decrype(c, d, n))
        print(long_to_bytes(m))
    except:
        pass
```

$\frac{ed}{2} = 1 \; mod \; φ(n)$

$ed = 2 \;mod\; φ(n)$

$c^d \; mod n = m^{e d} \; mod \; n=m^2\;mod\;n$
